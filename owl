#!/usr/bin/env python3
"""owl - natural language terraform for products"""

import argparse
import hashlib
import json
import subprocess
import sys
from datetime import datetime, timezone
from pathlib import Path

VERSION = "0.1.0"


def hash_content(content: str) -> str:
    """sha256 hash of content"""
    return hashlib.sha256(content.encode()).hexdigest()[:16]


def find_specs(dir: Path) -> dict[str, Path]:
    """gather all spec files from a project"""
    specs = {}

    product = dir / "product.md"
    if product.exists():
        specs["product"] = product

    constraints = dir / "constraints.md"
    if constraints.exists():
        specs["constraints"] = constraints

    for subdir in ["components", "behaviors"]:
        path = dir / subdir
        if path.exists():
            for f in path.glob("*.md"):
                key = f"{subdir}/{f.stem}"
                specs[key] = f

    return specs


def read_specs(specs: dict[str, Path]) -> tuple[str, dict[str, str]]:
    """read specs, return concatenated content and per-file hashes"""
    content = []
    hashes = {}

    for key, path in sorted(specs.items()):
        text = path.read_text()
        hashes[key] = hash_content(text)
        content.append(f"# FILE: {path.name}\n")
        content.append(text)
        content.append("\n---\n")

    return "\n".join(content), hashes


def load_state(dir: Path) -> dict:
    """load state file"""
    state_file = dir / ".owl" / "state.json"
    if state_file.exists():
        return json.loads(state_file.read_text())
    return {}


def save_state(dir: Path, state: dict):
    """save state file"""
    owl_dir = dir / ".owl"
    owl_dir.mkdir(exist_ok=True)
    state_file = owl_dir / "state.json"
    state_file.write_text(json.dumps(state, indent=2))


def run_claude(prompt: str, interactive: bool = False, auto_yes: bool = False) -> bool:
    """invoke claude cli, return success"""
    cmd = ["claude"]

    if not interactive:
        cmd.append("--print")
    elif auto_yes:
        cmd.append("--dangerously-skip-permissions")

    cmd.extend(["-p", prompt])

    try:
        subprocess.run(cmd, check=True)
        return True
    except FileNotFoundError:
        print("error: claude cli not found", file=sys.stderr)
        print("install: https://docs.anthropic.com/en/docs/claude-code", file=sys.stderr)
        sys.exit(1)
    except subprocess.CalledProcessError:
        return False


def cmd_init(dir: Path):
    """create initial spec files"""
    if (dir / "product.md").exists():
        print("error: product.md already exists", file=sys.stderr)
        sys.exit(1)

    (dir / "product.md").write_text("""# my product

one sentence description.

## components

- [component](components/component.md) - what it does

## behaviors

- [behavior](behaviors/behavior.md) - how it works

## constraints

see [constraints.md](constraints.md)
""")

    (dir / "constraints.md").write_text("""# constraints

## style

- describe preferences

## dependencies

- minimal
""")

    (dir / "components").mkdir(exist_ok=True)
    (dir / "behaviors").mkdir(exist_ok=True)

    # add .owl to gitignore
    gitignore = dir / ".gitignore"
    if gitignore.exists():
        content = gitignore.read_text()
        if ".owl/" not in content:
            gitignore.write_text(content + "\n.owl/\n")
    else:
        gitignore.write_text(".owl/\n")

    print("created product.md, constraints.md, components/, behaviors/")


def cmd_status(dir: Path, specs: str, hashes: dict[str, str]):
    """compare spec to reality"""
    state = load_state(dir)

    # check what's stale
    stale = []
    for key, h in hashes.items():
        stored = state.get("hashes", {}).get(key)
        if stored and stored != h:
            stale.append(key)

    if stale:
        print(f"stale specs (changed since last apply): {', '.join(stale)}\n")

    prompt = f"""you are owl. compare these specs to the codebase in {dir}.

report:
1. specified but missing (needs implementation)
2. exists but not specified (possible drift)
3. contradicts spec (needs fixing)

be concise. bullet points.

SPECS:
{specs}"""

    run_claude(prompt)


def cmd_plan(dir: Path, specs: str, hashes: dict[str, str]):
    """show what would change"""
    state = load_state(dir)
    spec_hash = hash_content(specs)

    if state.get("spec_hash") == spec_hash:
        print("spec unchanged since last apply.")
        print("use 'owl drift' to check if code still matches.\n")

    prompt = f"""you are owl. plan implementation from these specs for {dir}.

create a numbered task list:
1. what to build/modify
2. high-level description of each
3. any ambiguities or questions

do NOT implement. just plan.

SPECS:
{specs}"""

    run_claude(prompt)


def cmd_apply(dir: Path, specs: str, hashes: dict[str, str], auto_yes: bool = False):
    """build what's missing"""
    state = load_state(dir)
    spec_hash = hash_content(specs)

    if state.get("spec_hash") == spec_hash and state.get("status") == "satisfied":
        print("spec already satisfied. nothing to apply.")
        print("use 'owl drift' to verify, or delete .owl/state.json to force re-apply.")
        return

    prompt = f"""you are owl. implement these specs in {dir}.

rules:
- follow constraints strictly
- one component at a time
- verify each matches spec
- be minimal

SPECS:
{specs}"""

    success = run_claude(prompt, interactive=True, auto_yes=auto_yes)

    if success:
        now = datetime.now(timezone.utc).isoformat()
        state = {
            "spec_hash": spec_hash,
            "hashes": hashes,
            "status": "satisfied",
            "applied_at": now,
            "owl_version": VERSION,
        }
        save_state(dir, state)
        print(f"\nstate saved to .owl/state.json")


def cmd_drift(dir: Path, specs: str, hashes: dict[str, str]):
    """check for divergence"""
    prompt = f"""you are owl. detect drift between specs and code in {dir}.

report ONLY:
1. behavioral drift (code contradicts spec)
2. scope creep (code exceeds spec)
3. partial implementations

ignore implementation details not in spec.

SPECS:
{specs}"""

    run_claude(prompt)


def main():
    parser = argparse.ArgumentParser(
        description="owl - natural language terraform for products"
    )
    parser.add_argument("command", choices=["init", "status", "plan", "apply", "drift"])
    parser.add_argument("-d", "--dir", type=Path, default=Path.cwd(), help="project directory")
    parser.add_argument("-y", "--yes", action="store_true", help="auto-approve apply")
    parser.add_argument("--version", action="version", version=f"owl {VERSION}")

    args = parser.parse_args()
    dir = args.dir.resolve()

    if args.command == "init":
        cmd_init(dir)
        return

    specs = find_specs(dir)
    if not specs:
        print(f"error: no product.md found in {dir}", file=sys.stderr)
        print("run 'owl init' to create one", file=sys.stderr)
        sys.exit(1)

    spec_content, hashes = read_specs(specs)

    if args.command == "status":
        cmd_status(dir, spec_content, hashes)
    elif args.command == "plan":
        cmd_plan(dir, spec_content, hashes)
    elif args.command == "apply":
        cmd_apply(dir, spec_content, hashes, args.yes)
    elif args.command == "drift":
        cmd_drift(dir, spec_content, hashes)


if __name__ == "__main__":
    main()
